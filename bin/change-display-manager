#!/usr/bin/env bash
FZF_FLAGS="-1 --cycle --no-mouse --no-multi --no-scrollbar --ellipsis ... --layout reverse"

log() {
    echo -e "\x1b[33;1m$@...\x1b[0m" >&2
}

log_error() {
    error_code=$1
    message="$2"
    sleep_time=$3

    echo -e "\x1b[31;1m$message...\x1b[0m" >&2

    if test $sleep_time; then
        sleep $sleep_time
    fi

    exit $error_code
}

if ! which fzf &> /dev/null; then
    log_error 127 "fzf is required to run this, please install fzf"
fi

CHOSEN_DISPLAY_MANAGER="${1-$(echo -e 'greetd\nsddm' | fzf $FZF_FLAGS)}"

if test "$CHOSEN_DISPLAY_MANAGER" = ""; then
    log_error 1 "No display manager selected"
fi

default_display_manager="$(
    systemctl status display-manager --no-pager --plain --quiet \
        | grep -oP '(?<=\x{25cf} )(.+)(?=\.service.+)'
)"

if test "$CHOSEN_DISPLAY_MANAGER" = "$default_display_manager"; then
    log_error 1 "You are already using $CHOSEN_DISPLAY_MANAGER" 3
fi

log "Changing display manager to $CHOSEN_DISPLAY_MANAGER"

sudo systemctl disable --now $default_display_manager \
    && sudo systemctl enable --now $CHOSEN_DISPLAY_MANAGER \
    &> /dev/null
